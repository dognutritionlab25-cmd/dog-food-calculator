import os
import time
import re
import subprocess

# --- [0. í•„ìˆ˜ í”„ë¡œê·¸ë¨ ì„¤ì¹˜] (ëŸ°íƒ€ì„ ì´ˆê¸°í™” í›„ì—ëŠ” ê¼­ í•„ìš”í•©ë‹ˆë‹¤!) ---
print("ğŸ“¦ í•„ìˆ˜ í”„ë¡œê·¸ë¨(Streamlit, Pandas) ì„¤ì¹˜ ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)")
os.system("pip install -q streamlit pandas")
os.system("wget -q -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64")
os.system("chmod +x cloudflared")

# --- [1. ê¼¬ì¸ ì—°ê²° í’€ê¸°] ---
print("ğŸ§¹ ê¸°ì¡´ ì—°ê²° ì •ë¦¬ ì¤‘...")
os.system("pkill -9 cloudflared")
os.system("pkill -9 streamlit")
os.system("rm -f tunnel.log")

# --- [2. ì•± ì½”ë“œ ìƒì„± (ë”°ì˜´í‘œ ì˜¤ë¥˜ ìˆ˜ì • + ê¸°ëŠ¥ í’€íƒ‘ì¬)] ---
app_code = """
import streamlit as st
import pandas as pd

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë°˜ë ¤ê²¬ ì˜ì–‘ ì—°êµ¬ì†Œ ê³„ì‚°ê¸° v3.4", layout="wide")

# --- [ìƒë‹¨ í—¤ë”] ---
st.title("ğŸ¶ ë°˜ë ¤ê²¬ ì˜ì–‘ ì—°êµ¬ì†Œ [AAFCO ìƒì‹ ê³„ì‚°ê¸° v3.4]")
st.info("ğŸ’¡ ì „ë¬¸ê°€ìš© ë§ì¶¤í˜• ì˜ì–‘ ì»¨ì„¤íŒ… & ë ˆì‹œí”¼ ë¶„ì„ ì‹œìŠ¤í…œ")

# --- [1. AAFCO ê¸°ì¤€] ---
aafco_standards = {
    "ë‹¨ë°±ì§ˆ(g)": {"min": 45, "max": None},
    "ì§€ë°©(g)": {"min": 13.8, "max": None},
    "ì¹¼ìŠ˜(mg)": {"min": 1250, "max": 6250},
    "ì¸(mg)": {"min": 1000, "max": 4000},
    "ì² (mg)": {"min": 10, "max": None},
    "ì•„ì—°(mg)": {"min": 20, "max": None},
    "êµ¬ë¦¬(mg)": {"min": 1.83, "max": None},
    "ë§ê°„(mg)": {"min": 1.25, "max": None},
    "ë¹„íƒ€ë¯¼A(IU)": {"min": 1250, "max": None},
    "ë¹„íƒ€ë¯¼D(IU)": {"min": 125, "max": None},
    "ë¹„íƒ€ë¯¼E(IU)": {"min": 12.5, "max": None},
    "ë‚˜íŠ¸ë¥¨(mg)": {"min": 200, "max": None},
}

# --- [2. ë°ì´í„°ë² ì´ìŠ¤] ---
db_data = [
    {"ì¬ë£Œëª…": "ë‹­ë°œ (ë¼ˆ 60%)", "category": "bone", "bone_pct": 0.60, "ì¹¼ë¡œë¦¬": 215, "ë‹¨ë°±ì§ˆ": 19.0, "ì§€ë°©": 14.6, "ì¹¼ìŠ˜": 2500, "ì¸": 1500, "ì² ": 2.0, "ì•„ì—°": 1.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.05, "ë¹„íƒ€ë¯¼A": 30, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 67},
    {"ì¬ë£Œëª…": "ë‹­ëª©ë¼ˆ (ë¼ˆ 36%)", "category": "bone", "bone_pct": 0.36, "ì¹¼ë¡œë¦¬": 154, "ë‹¨ë°±ì§ˆ": 17.6, "ì§€ë°©": 8.78, "ì¹¼ìŠ˜": 1500, "ì¸": 900, "ì² ": 2.06, "ì•„ì—°": 2.68, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.03, "ë¹„íƒ€ë¯¼A": 146, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 81},
    {"ì¬ë£Œëª…": "ë‹­ë‚ ê°œ (ë¼ˆ 45%)", "category": "bone", "bone_pct": 0.45, "ì¹¼ë¡œë¦¬": 203, "ë‹¨ë°±ì§ˆ": 18.0, "ì§€ë°©": 14.0, "ì¹¼ìŠ˜": 1875, "ì¸": 1125, "ì² ": 1.0, "ì•„ì—°": 1.0, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 40, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0.3, "ë‚˜íŠ¸ë¥¨": 70},
    {"ì¬ë£Œëª…": "ë‹­ë¶ì±„ (ë¼ˆ 30%)", "category": "bone", "bone_pct": 0.30, "ì¹¼ë¡œë¦¬": 120, "ë‹¨ë°±ì§ˆ": 18.0, "ì§€ë°©": 4.0, "ì¹¼ìŠ˜": 1250, "ì¸": 750, "ì² ": 0.8, "ì•„ì—°": 1.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 20, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0.2, "ë‚˜íŠ¸ë¥¨": 80},
    {"ì¬ë£Œëª…": "ì „ì²´ ì¹ ë©´ì¡° (ë¼ˆ 21%)", "category": "bone", "bone_pct": 0.21, "ì¹¼ë¡œë¦¬": 160, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 8.0, "ì¹¼ìŠ˜": 875, "ì¸": 525, "ì² ": 1.5, "ì•„ì—°": 2.0, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 50, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 60},
    {"ì¬ë£Œëª…": "ì¹ ë©´ì¡° ëª©ë¼ˆ (ë¼ˆ 42%)", "category": "bone", "bone_pct": 0.42, "ì¹¼ë¡œë¦¬": 225, "ë‹¨ë°±ì§ˆ": 30.0, "ì§€ë°©": 11.0, "ì¹¼ìŠ˜": 1750, "ì¸": 1050, "ì² ": 2.0, "ì•„ì—°": 3.0, "êµ¬ë¦¬": 0.2, "ë§ê°„": 0.04, "ë¹„íƒ€ë¯¼A": 40, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 90},
    {"ì¬ë£Œëª…": "ì¹ ë©´ì¡° ë‚ ê°œ (ë¼ˆ 37%)", "category": "bone", "bone_pct": 0.37, "ì¹¼ë¡œë¦¬": 200, "ë‹¨ë°±ì§ˆ": 18.0, "ì§€ë°©": 13.0, "ì¹¼ìŠ˜": 1540, "ì¸": 925, "ì² ": 1.5, "ì•„ì—°": 1.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 30, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 80},
    {"ì¬ë£Œëª…": "ì „ì²´ ì˜¤ë¦¬ (ë¼ˆ 28%)", "category": "bone", "bone_pct": 0.28, "ì¹¼ë¡œë¦¬": 250, "ë‹¨ë°±ì§ˆ": 15.0, "ì§€ë°©": 20.0, "ì¹¼ìŠ˜": 1166, "ì¸": 700, "ì² ": 2.5, "ì•„ì—°": 1.8, "êµ¬ë¦¬": 0.2, "ë§ê°„": 0.03, "ë¹„íƒ€ë¯¼A": 60, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0.5, "ë‚˜íŠ¸ë¥¨": 65},
    {"ì¬ë£Œëª…": "ì˜¤ë¦¬ ëª©ë¼ˆ (ë¼ˆ 50%)", "category": "bone", "bone_pct": 0.50, "ì¹¼ë¡œë¦¬": 250, "ë‹¨ë°±ì§ˆ": 18.0, "ì§€ë°©": 18.0, "ì¹¼ìŠ˜": 2083, "ì¸": 1250, "ì² ": 2.8, "ì•„ì—°": 2.0, "êµ¬ë¦¬": 0.2, "ë§ê°„": 0.04, "ë¹„íƒ€ë¯¼A": 50, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 85},
    {"ì¬ë£Œëª…": "ì˜¤ë¦¬ë°œ (ë¼ˆ 60%)", "category": "bone", "bone_pct": 0.60, "ì¹¼ë¡œë¦¬": 253, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 18.0, "ì¹¼ìŠ˜": 2500, "ì¸": 1500, "ì² ": 2.0, "ì•„ì—°": 1.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.05, "ë¹„íƒ€ë¯¼A": 40, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 90},
    {"ì¬ë£Œëª…": "ì†Œê°ˆë¹„ë¼ˆ (ë¼ˆ 52%)", "category": "bone", "bone_pct": 0.52, "ì¹¼ë¡œë¦¬": 300, "ë‹¨ë°±ì§ˆ": 18.0, "ì§€ë°©": 25.0, "ì¹¼ìŠ˜": 2166, "ì¸": 1300, "ì² ": 3.0, "ì•„ì—°": 4.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 10, "ë¹„íƒ€ë¯¼D": 2, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 70},
    {"ì¬ë£Œëª…": "ì†Œê¼¬ë¦¬ (ë¼ˆ 55%)", "category": "bone", "bone_pct": 0.55, "ì¹¼ë¡œë¦¬": 262, "ë‹¨ë°±ì§ˆ": 21.0, "ì§€ë°©": 18.0, "ì¹¼ìŠ˜": 2290, "ì¸": 1375, "ì² ": 4.9, "ì•„ì—°": 3.5, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 0, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 60},
    {"ì¬ë£Œëª…": "ì–‘ ê°ˆë¹„ë¼ˆ (ë¼ˆ 27%)", "category": "bone", "bone_pct": 0.27, "ì¹¼ë¡œë¦¬": 355, "ë‹¨ë°±ì§ˆ": 22.0, "ì§€ë°©": 30.0, "ì¹¼ìŠ˜": 1125, "ì¸": 675, "ì² ": 2.0, "ì•„ì—°": 4.0, "êµ¬ë¦¬": 0.1, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 0, "ë¹„íƒ€ë¯¼D": 1, "ë¹„íƒ€ë¯¼E": 0.1, "ë‚˜íŠ¸ë¥¨": 76},
    {"ì¬ë£Œëª…": "ì–‘ ëª©ë¼ˆ (ë¼ˆ 32%)", "category": "bone", "bone_pct": 0.32, "ì¹¼ë¡œë¦¬": 260, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 20.0, "ì¹¼ìŠ˜": 1333, "ì¸": 800, "ì² ": 4.0, "ì•„ì—°": 4.2, "êµ¬ë¦¬": 0.2, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 0, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 70},
    {"ì¬ë£Œëª…": "ì „ì²´ ë©”ì¸„ë¦¬ (ë¼ˆ 10%)", "category": "bone", "bone_pct": 0.10, "ì¹¼ë¡œë¦¬": 200, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 12.0, "ì¹¼ìŠ˜": 416, "ì¸": 250, "ì² ": 4.0, "ì•„ì—°": 2.5, "êµ¬ë¦¬": 0.5, "ë§ê°„": 0.02, "ë¹„íƒ€ë¯¼A": 50, "ë¹„íƒ€ë¯¼D": 10, "ë¹„íƒ€ë¯¼E": 1.0, "ë‚˜íŠ¸ë¥¨": 50},
    {"ì¬ë£Œëª…": "ì†Œê°„ (Beef Liver)", "category": "organ", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 135, "ë‹¨ë°±ì§ˆ": 20.4, "ì§€ë°©": 3.63, "ì¹¼ìŠ˜": 5, "ì¸": 387, "ì² ": 4.9, "ì•„ì—°": 4.0, "êµ¬ë¦¬": 9.76, "ë§ê°„": 0.31, "ë¹„íƒ€ë¯¼A": 16900, "ë¹„íƒ€ë¯¼D": 49, "ë¹„íƒ€ë¯¼E": 0.38, "ë‚˜íŠ¸ë¥¨": 69},
    {"ì¬ë£Œëª…": "ì†Œì‹¬ì¥ (Beef Heart)", "category": "organ", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 112, "ë‹¨ë°±ì§ˆ": 18.5, "ì§€ë°©": 3.4, "ì¹¼ìŠ˜": 4, "ì¸": 209, "ì² ": 4.38, "ì•„ì—°": 1.51, "êµ¬ë¦¬": 0.373, "ë§ê°„": 0.034, "ë¹„íƒ€ë¯¼A": 34, "ë¹„íƒ€ë¯¼D": 6, "ë¹„íƒ€ë¯¼E": 1.22, "ë‚˜íŠ¸ë¥¨": 86},
    {"ì¬ë£Œëª…": "ì†Œí (Beef Lung)", "category": "organ", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 92, "ë‹¨ë°±ì§ˆ": 16.2, "ì§€ë°©": 2.5, "ì¹¼ìŠ˜": 10, "ì¸": 224, "ì² ": 7.95, "ì•„ì—°": 1.61, "êµ¬ë¦¬": 0.26, "ë§ê°„": 0.019, "ë¹„íƒ€ë¯¼A": 46, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 198},
    {"ì¬ë£Œëª…": "ê·¸ë¦°íŠ¸ë¼ì´í”„ (Green Tripe)", "category": "organ", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 85, "ë‹¨ë°±ì§ˆ": 14.9, "ì§€ë°©": 1.98, "ì¹¼ìŠ˜": 112, "ì¸": 159, "ì² ": 4.44, "ì•„ì—°": 1.72, "êµ¬ë¦¬": 0.094, "ë§ê°„": 4.06, "ë¹„íƒ€ë¯¼A": 20, "ë¹„íƒ€ë¯¼D": 8, "ë¹„íƒ€ë¯¼E": 0.45, "ë‚˜íŠ¸ë¥¨": 81},
    {"ì¬ë£Œëª…": "ë‹­ê°€ìŠ´ì‚´ (Chicken Breast)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 120, "ë‹¨ë°±ì§ˆ": 22.5, "ì§€ë°©": 2.62, "ì¹¼ìŠ˜": 5, "ì¸": 213, "ì² ": 0.37, "ì•„ì—°": 0.68, "êµ¬ë¦¬": 0.037, "ë§ê°„": 0.011, "ë¹„íƒ€ë¯¼A": 30, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0.56, "ë‚˜íŠ¸ë¥¨": 45},
    {"ì¬ë£Œëª…": "ì†Œê³ ê¸° (Beef)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 152, "ë‹¨ë°±ì§ˆ": 20.8, "ì§€ë°©": 7.0, "ì¹¼ìŠ˜": 10, "ì¸": 192, "ì² ": 2.33, "ì•„ì—°": 4.97, "êµ¬ë¦¬": 0.075, "ë§ê°„": 0.01, "ë¹„íƒ€ë¯¼A": 14, "ë¹„íƒ€ë¯¼D": 3, "ë¹„íƒ€ë¯¼E": 0.17, "ë‚˜íŠ¸ë¥¨": 66},
    {"ì¬ë£Œëª…": "ë§ê³ ê¸° (Horse Meat)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 133, "ë‹¨ë°±ì§ˆ": 21.4, "ì§€ë°©": 4.6, "ì¹¼ìŠ˜": 6, "ì¸": 221, "ì² ": 3.82, "ì•„ì—°": 2.9, "êµ¬ë¦¬": 0.144, "ë§ê°„": 0.019, "ë¹„íƒ€ë¯¼A": 0, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 53},
    {"ì¬ë£Œëª…": "ì‚¬ìŠ´ê³ ê¸° (Venison)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 116, "ë‹¨ë°±ì§ˆ": 21.5, "ì§€ë°©": 2.66, "ì¹¼ìŠ˜": 7, "ì¸": 201, "ì² ": 2.92, "ì•„ì—°": 4.2, "êµ¬ë¦¬": 0.14, "ë§ê°„": 0.014, "ë¹„íƒ€ë¯¼A": 0, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0, "ë‚˜íŠ¸ë¥¨": 75},
    {"ì¬ë£Œëª…": "ì •ì–´ë¦¬ (Sardine)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 208, "ë‹¨ë°±ì§ˆ": 24.6, "ì§€ë°©": 11.4, "ì¹¼ìŠ˜": 382, "ì¸": 490, "ì² ": 2.92, "ì•„ì—°": 1.4, "êµ¬ë¦¬": 0.186, "ë§ê°„": 0, "ë¹„íƒ€ë¯¼A": 30, "ë¹„íƒ€ë¯¼D": 4.8, "ë¹„íƒ€ë¯¼E": 1.38, "ë‚˜íŠ¸ë¥¨": 307},
    {"ì¬ë£Œëª…": "ê³„ë€ë…¸ë¥¸ì (Egg Yolk)", "category": "meat", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 322, "ë‹¨ë°±ì§ˆ": 15.9, "ì§€ë°©": 26.5, "ì¹¼ìŠ˜": 129, "ì¸": 390, "ì² ": 2.73, "ì•„ì—°": 2.3, "êµ¬ë¦¬": 0.077, "ë§ê°„": 0.31, "ë¹„íƒ€ë¯¼A": 1440, "ë¹„íƒ€ë¯¼D": 49, "ë¹„íƒ€ë¯¼E": 0.38, "ë‚˜íŠ¸ë¥¨": 48},
    {"ì¬ë£Œëª…": "í•´ë°”ë¼ê¸°ì”¨ (Sunflower Seed)", "category": "veggie", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 559, "ë‹¨ë°±ì§ˆ": 30.2, "ì§€ë°©": 49.0, "ì¹¼ìŠ˜": 46, "ì¸": 1230, "ì² ": 8.82, "ì•„ì—°": 7.81, "êµ¬ë¦¬": 1.34, "ë§ê°„": 4.54, "ë¹„íƒ€ë¯¼A": 3.3, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 2.18, "ë‚˜íŠ¸ë¥¨": 7},
    {"ì¬ë£Œëª…": "êµ´ (Oyster)", "category": "veggie", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 68, "ë‹¨ë°±ì§ˆ": 7.67, "ì§€ë°©": 2.68, "ì¹¼ìŠ˜": 49, "ì¸": 151, "ì² ": 7.28, "ì•„ì—°": 98.9, "êµ¬ë¦¬": 4.85, "ë§ê°„": 0.45, "ë¹„íƒ€ë¯¼A": 326, "ë¹„íƒ€ë¯¼D": 1, "ë¹„íƒ€ë¯¼E": 0.92, "ë‚˜íŠ¸ë¥¨": 122},
    {"ì¬ë£Œëª…": "ë¸”ë£¨ë² ë¦¬ (Blueberry)", "category": "veggie", "bone_pct": 0, "ì¹¼ë¡œë¦¬": 57, "ë‹¨ë°±ì§ˆ": 0.74, "ì§€ë°©": 0.33, "ì¹¼ìŠ˜": 6, "ì¸": 12, "ì² ": 0.28, "ì•„ì—°": 0.06, "êµ¬ë¦¬": 1.6, "ë§ê°„": 0.262, "ë¹„íƒ€ë¯¼A": 54, "ë¹„íƒ€ë¯¼D": 0, "ë¹„íƒ€ë¯¼E": 0.57, "ë‚˜íŠ¸ë¥¨": 1},
]
food_df = pd.DataFrame(db_data)

# --- [3. ë©”ì¸ í™”ë©´] ---
col1, col2 = st.columns([1, 2])
with col1:
    st.subheader("ğŸ• ê°•ì•„ì§€ ì •ë³´")
    weight = st.number_input("ëª¸ë¬´ê²Œ (kg)", 0.1, 60.0, 3.0, step=0.1)
    # í™œë™ëŸ‰ ë° ìƒíƒœ ì„ íƒ ê°€ì´ë“œ (ì„¤ëª… ì¶”ê°€)
    der_options = {
        "1.0: ì²´ì¤‘ ê°ëŸ‰ (ë‹¤ì´ì–´íŠ¸ í•„ìš”)": 1.0,
        "1.2: ì¤‘ì„±í™”í•œ ì„±ê²¬ (ë‚®ì€ í™œë™ëŸ‰)": 1.2,
        "1.4: ì¤‘ì„±í™” ì•ˆ í•œ ì„±ê²¬ / ì•½ê°„ ë§ˆë¥¸ ì²´í˜•": 1.4,
        "1.6: ë³´í†µ í™œë™ëŸ‰ì˜ ì„±ê²¬ (ê¶Œì¥)": 1.6,
        "1.8: ë§¤ìš° í™œë™ì ì¸ ì„±ê²¬": 1.8,
        "2.0: ì²´ì¤‘ ì¦ê°€ê°€ í•„ìš”í•œ ì„±ê²¬": 2.0,
        "3.0: ì„±ì¥ê¸° ê°•ì•„ì§€ (í¼í”¼)": 3.0
    }

    selected_label = st.selectbox(
        "ìš°ë¦¬ ì•„ì´ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!",
        options=list(der_options.keys()),
        index=3
    )

    # ì„ íƒëœ í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ìë§Œ ê°€ì ¸ì™€ì„œ ê³„ì‚°ì— ì‚¬ìš©
    activity = der_options[selected_label]
    rer = 70 * (weight ** 0.75)
    der = rer * activity
    st.metric(label="í•˜ë£¨ ëª©í‘œ ì¹¼ë¡œë¦¬ (DER)", value=f"{der:.1f} kcal")

with col2:
    st.subheader("ğŸ¥© ëƒ‰ì¥ê³  í„¸ê¸° (ì¬ë£Œ ì„ íƒ)")
    all_foods = food_df['ì¬ë£Œëª…'].tolist()
    bone_options = [f for f in all_foods if "ë¼ˆ" in f or "ë°œ" in f or "ë‚ ê°œ" in f or "ì „ì²´" in f]
    default_selections = [bone_options[0]] if bone_options else []
    selected = st.multiselect("ì¬ë£Œë¥¼ ê³ ë¥´ì„¸ìš”:", all_foods, default=default_selections)

amounts = {}
if selected:
    cols = st.columns(3)
    for i, f in enumerate(selected):
        with cols[i % 3]:
            amounts[f] = st.number_input(f"{f} (g)", 0, 1000, 50, step=5)

# --- [4. ê³„ì‚° ë° íŒì •] ---
if selected:
    st.divider()

    total_grams = sum(amounts.values())
    mass_breakdown = {"actual_bone": 0, "muscle_meat": 0, "organ": 0, "veggie": 0}
    total_stats = {k: 0 for k in aafco_standards.keys()}
    total_kcal = 0
    recipe_save_list = []

    for f in selected:
        grams = amounts[f]
        if grams > 0:
            recipe_save_list.append({"ì¬ë£Œëª…": f, "ê¸‰ì—¬ëŸ‰(g)": grams})
            row = food_df[food_df['ì¬ë£Œëª…'] == f].iloc[0]
            ratio = grams / 100
            total_kcal += row['ì¹¼ë¡œë¦¬'] * ratio
            for nutri in aafco_standards.keys():
                col_name = nutri.split("(")[0]
                if col_name in row:
                    total_stats[nutri] += row[col_name] * ratio

            cat, b_pct = row['category'], row['bone_pct']
            if cat == 'bone':
                mass_breakdown['actual_bone'] += grams * b_pct
                mass_breakdown['muscle_meat'] += grams * (1 - b_pct)
            elif cat == 'meat':
                mass_breakdown['muscle_meat'] += grams
            elif cat == 'organ':
                mass_breakdown['organ'] += grams
            else:
                mass_breakdown['veggie'] += grams

    # --- ë ˆì‹œí”¼ ë‹¤ìš´ë¡œë“œ & PDF ì•ˆë‚´ ---
    st.subheader("ğŸ’¾ ë ˆì‹œí”¼ ì €ì¥ ë° ê³ ê° ë°œì†¡")
    c_btn1, c_btn2 = st.columns(2)

    with c_btn1:
        if recipe_save_list:
            df_recipe = pd.DataFrame(recipe_save_list)
            csv = df_recipe.to_csv(index=False).encode('utf-8-sig')
            st.download_button(
                label="ğŸ“¥ ì—‘ì…€(CSV) íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°",
                data=csv,
                file_name=f"ì˜ì–‘ë ˆì‹œí”¼_{weight}kg.csv",
                mime="text/csv",
            )
    with c_btn2:
        with st.expander("ğŸ–¨ï¸ PDFë¡œ ì €ì¥í•´ì„œ ê³ ê°ì—ê²Œ ë³´ë‚´ë ¤ë©´?"):
            # ë”°ì˜´í‘œ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ì‘ì€ë”°ì˜´í‘œ ì‚¬ìš©
            st.markdown('''
            1. í‚¤ë³´ë“œì—ì„œ **`Ctrl + P`** (ë§¥ë¶ì€ `Command + P`)ë¥¼ ëˆ„ë¥´ì„¸ìš”.
            2. ì¸ì‡„ ì„¤ì • ì°½ì´ ëœ¨ë©´ **[ëŒ€ìƒ(í”„ë¦°í„°)]**ë¥¼ **'PDFë¡œ ì €ì¥'**ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
            3. **[ì €ì¥]** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ í™”ë©´ ê·¸ëŒ€ë¡œ ì˜ˆìœ ë¦¬í¬íŠ¸ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤!
            ''')

    st.divider()

    # --- ë¶„ì„ ê²°ê³¼ í™”ë©´ ---
    c1, c2 = st.columns([1, 2])
    with c1:
        st.subheader("âš–ï¸ ì‹ë‹¨ ë¹„ìœ¨")
        st.metric("ì´ ê¸‰ì—¬ëŸ‰", f"{total_grams:.1f} g")

        if total_grams > 0:
            pct_bone = (mass_breakdown['actual_bone'] / total_grams) * 100
            pct_meat = (mass_breakdown['muscle_meat'] / total_grams) * 100
            pct_organ = (mass_breakdown['organ'] / total_grams) * 100
            pct_veggie = (mass_breakdown['veggie'] / total_grams) * 100

            st.write(f"ğŸ¦´ **ë¼ˆ ({pct_bone:.1f}%)** | ëª©í‘œ 12%")
            st.progress(min(pct_bone/20, 1.0))
            st.write(f"ğŸ¥© **ì‚´ì½”ê¸° ({pct_meat:.1f}%)** | ëª©í‘œ 60~70%")
            st.progress(min(pct_meat/100, 1.0))
            st.write(f"ğŸ«€ **ë‚´ì¥ ({pct_organ:.1f}%)** | ëª©í‘œ 10~25%")
            st.progress(min(pct_organ/40, 1.0))
            st.write(f"ğŸ¥¦ **ì•¼ì±„ ({pct_veggie:.1f}%)** | ëª©í‘œ 5~10%")
            st.progress(min(pct_veggie/20, 1.0))

    with c2:
        st.subheader("ğŸ“Š AAFCO ì˜ì–‘ ë¶„ì„")
        res_data = []
        if total_kcal > 0:
            kcal_ratio = (total_kcal / der) * 100
            st.progress(min(kcal_ratio/100, 1.0), text=f"ì¹¼ë¡œë¦¬ ì¶©ì¡±ë¥ : {kcal_ratio:.1f}%")

            for nutri, std in aafco_standards.items():
                val_1000 = (total_stats[nutri] / total_kcal) * 1000
                min_v, max_v = std['min'], std['max']
                status = "âœ… ì í•©"
                if val_1000 < min_v: status = f"âŒ ë¶€ì¡± (ìµœì†Œ {min_v})"
                elif max_v and val_1000 > max_v: status = f"âš ï¸ ê³¼ì‰ (ìµœëŒ€ {max_v})"

                res_data.append({"ì˜ì–‘ì†Œ": nutri, "í˜„ì¬(1000kcalë‹¹)": f"{val_1000:.2f}", "AAFCO ê¸°ì¤€": f"{min_v}~{max_v if max_v else ''}", "íŒì •": status})

            res_df = pd.DataFrame(res_data)
            def color_status(val):
                return f'color: {"green" if "ì í•©" in val else "red" if "ë¶€ì¡±" in val else "orange"}; font-weight: bold'
            st.dataframe(res_df.style.map(color_status, subset=['íŒì •']), use_container_width=True)

            ca, p = total_stats["ì¹¼ìŠ˜(mg)"], total_stats["ì¸(mg)"]
            if p > 0:
                ratio = ca / p
                st.info(f"ğŸ¦´ **Ca:P ë¹„ìœ¨ = {ratio:.2f} : 1** (ê¶Œì¥ 1.1~2 : 1)")

else:
    st.info("ì¬ë£Œë¥¼ ì„ íƒí•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.")
"""

with open("app.py", "w", encoding='utf-8') as f:
    f.write(app_code.strip())

# --- [3. ì‹¤í–‰ ë° ì£¼ì†Œ ìë™ ì°¾ê¸°] ---
print("ğŸš€ [ë°˜ë ¤ê²¬ ì˜ì–‘ ì—°êµ¬ì†Œ v3.4] ê°€ë™ ì‹œì‘! (ì ì‹œ í›„ ë§í¬ê°€ ëœ¹ë‹ˆë‹¤)")
os.system("nohup ./cloudflared tunnel --url http://localhost:8501 > tunnel.log 2>&1 &")

found_url = None
for i in range(30):
    time.sleep(1)
    if os.path.exists("tunnel.log"):
        with open("tunnel.log", "r") as f:
            match = re.search(r'https://[\w-]+\.trycloudflare\.com', f.read())
            if match:
                found_url = match.group(0)
                break
    print(".", end="", flush=True)

print(f"\n\nğŸ‰ [ì ‘ì† ì£¼ì†Œ]: {found_url}")
